<!doctype html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ICS Simulator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="/_sdk/data_sdk.js"></script>
<script src="/_sdk/element_sdk.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;500;600;700&amp;family=Inter:wght@400;500;600&amp;display=swap" rel="stylesheet">
<style>
:root {
    --primary-blue: #06b6d4;
    --secondary-blue: #3b82f6;
    --dark-bg: #020617;
    --panel-bg: rgba(15, 23, 42, 0.8);
    --border-glow: rgba(6, 182, 212, 0.5);
    --text-glow: rgba(6, 182, 212, 0.8);
}
body {
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
    background-color: var(--dark-bg);
    color: #e2e8f0;
    overflow-x: hidden;
}
h1, h2, h3, h4, .game-title, .btn-text {
    font-family: 'Roboto Condensed', sans-serif;
    text-transform: uppercase;
    letter-spacing: 1px;
}
/* Futuristic Glow Effects */
.glow-text {
    text-shadow: 0 0 10px var(--text-glow);
}
.glow-border {
    box-shadow: 0 0 15px var(--border-glow);
    border: 1px solid var(--primary-blue);
}
.glow-panel {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 58, 138, 0.4) 100%);
    border: 1px solid rgba(6, 182, 212, 0.3);
    backdrop-filter: blur(10px);
}
/* Animations */
@keyframes pulse-alert {
    0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--primary-blue); }
    50% { opacity: 0.7; box-shadow: 0 0 20px var(--primary-blue); }
}
@keyframes scanline {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(100%); }
}
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-3px); }
    75% { transform: translateX(3px); }
}
.alert-pulse {
    animation: pulse-alert 2s ease-in-out infinite;
}
.float-animation {
    animation: float 3s ease-in-out infinite;
}
.shake-effect {
    animation: shake 0.3s ease-in-out infinite;
}
.scanline-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, transparent 50%, rgba(6, 182, 212, 0.05) 51%);
    background-size: 100% 4px;
    pointer-events: none;
    z-index: 9999;
}
/* Map & Grid */
.map-container {
    display: grid;
    grid-template-columns: 1fr 240px;
    gap: 16px;
    align-items: start;
}
.map-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(8, 1fr);
    gap: 2px;
    background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
    padding: 10px;
    border-radius: 4px;
    border: 1px solid var(--primary-blue);
    min-height: 400px;
    position: relative;
    overflow: hidden;
}
.map-grid::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: linear-gradient(var(--border-glow) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-glow) 1px, transparent 1px);
    background-size: 20px 20px;
    opacity: 0.1;
    pointer-events: none;
}
.cell {
    aspect-ratio: 1;
    border-radius: 2px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    border: 1px solid rgba(6, 182, 212, 0.2);
    background: rgba(15, 23, 42, 0.6);
}
.cell:hover {
    transform: scale(1.1);
    z-index: 10;
    border-color: var(--primary-blue);
    box-shadow: 0 0 15px var(--border-glow);
}
.cell-water { background: rgba(6, 182, 212, 0.2); border-color: rgba(6, 182, 212, 0.4); }
.cell-land { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); }
.cell-urban { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); }
.cell-flooded { background: rgba(99, 102, 241, 0.4); border-color: rgba(99, 102, 241, 0.8); animation: pulse-alert 2s infinite; }
.cell-affected { background: rgba(239, 68, 68, 0.4); border-color: rgba(239, 68, 68, 0.8); }
.cell-evacuated { background: rgba(245, 158, 11, 0.4); border-color: rgba(245, 158, 11, 0.8); }
.cell-safe { background: rgba(16, 185, 129, 0.4); border-color: rgba(16, 185, 129, 0.8); }

/* UI Components */
.btn-primary {
    background: linear-gradient(90deg, var(--secondary-blue), var(--primary-blue));
    color: white;
    font-family: 'Roboto Condensed', sans-serif;
    font-weight: 700;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.btn-primary:hover {
    box-shadow: 0 0 20px var(--border-glow);
    transform: translateY(-2px);
}
.btn-primary::after {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
    transform: rotate(45deg);
    transition: all 0.5s;
}
.btn-primary:hover::after {
    left: 100%;
}
.ics-section-card {
    background: rgba(30, 41, 59, 0.5);
    border-left: 3px solid var(--primary-blue);
    transition: all 0.3s;
}
.ics-section-card:hover {
    background: rgba(30, 41, 59, 0.8);
    border-left-width: 5px;
}
.stat-box {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.3);
    border-radius: 4px;
}
.progress-bar {
    transition: width 0.5s ease;
    box-shadow: 0 0 10px var(--border-glow);
}
.tooltip {
    visibility: hidden;
    opacity: 0;
    transition: all 0.2s ease;
    pointer-events: none;
    z-index: 100;
}
.has-tooltip:hover .tooltip {
    visibility: visible;
    opacity: 1;
}
.tooltip-content {
    background: #0f172a;
    border: 1px solid var(--primary-blue);
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    color: #e2e8f0;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}
.modal-overlay {
    background: rgba(2, 6, 23, 0.9);
    backdrop-filter: blur(5px);
}
.scrollbar-thin::-webkit-scrollbar {
    width: 6px;
}
.scrollbar-thin::-webkit-scrollbar-track {
    background: #0f172a;
}
.scrollbar-thin::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 3px;
}
/* Radar Chart Container */
.radar-container {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto;
}
</style>
<style>@view-transition { navigation: auto; }</style>
</head>
<body class="h-full bg-slate-950 text-white overflow-auto">
<div class="scanline-overlay"></div>
<div id="app" class="h-full w-full">
    <!-- Title Screen -->
    <div id="title-screen" class="h-full w-full flex flex-col items-center justify-center p-6 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <div class="text-center max-w-3xl relative">
            <div class="absolute -top-20 -left-20 w-40 h-40 bg-cyan-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            <div class="absolute -bottom-20 -right-20 w-40 h-40 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            
            <div class="mb-6 relative z-10">
                <svg class="w-32 h-32 mx-auto text-cyan-400 float-animation" viewBox="0 0 100 100" fill="none">
                    <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="2" class="opacity-50"/>
                    <path d="M50 20 L50 55 L70 70" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="50" cy="50" r="6" fill="currentColor"/>
                    <path d="M25 50 L15 50 M75 50 L85 50 M50 25 L50 15 M50 75 L50 85" stroke="currentColor" stroke-width="2"/>
                    <circle cx="50" cy="50" r="35" stroke="currentColor" stroke-width="1" stroke-dasharray="4 4" class="animate-spin-slow" style="animation-duration: 10s"/>
                </svg>
            </div>
            <h1 id="main-title" class="game-title text-5xl md:text-6xl font-bold text-cyan-400 mb-2 glow-text">PH-ICS SIMULATOR</h1>
            <h2 id="sub-title" class="text-xl md:text-2xl text-blue-200 mb-4 tracking-widest">Incident Command System Training</h2>
            <p id="lgu-display" class="text-lg text-cyan-300 mb-8 font-light">Republic of the Philippines ‚Ä¢ NDRRMC Standard</p>
            <p id="welcome-text" class="text-slate-400 mb-10 leading-relaxed max-w-xl mx-auto">Master emergency response through realistic disaster scenarios. Adhere to ICS protocols, manage clusters, and coordinate rescue operations using scientific decision rubrics.</p>
            
            <div class="space-y-4 mb-8 relative z-10">
                <input type="text" id="player-name" placeholder="Enter Operator Name" class="w-full max-w-xs px-4 py-3 bg-slate-900/50 border border-cyan-800 rounded text-center focus:border-cyan-500 focus:outline-none transition-colors text-cyan-100 placeholder-slate-600">
            </div>
            
            <button id="start-btn" onclick="startGame()" class="btn-primary px-10 py-4 rounded text-lg shadow-lg relative group has-tooltip">
                üö® INITIALIZE SIMULATION
                <div class="tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-3 group-hover:visible group-hover:opacity-100">
                    <div class="tooltip-content flex items-center gap-2">
                        Begin ICS Training Protocol
                        <div class="tooltip-arrow"></div>
                    </div>
                </div>
            </button>
            
            <div class="mt-12 flex justify-center gap-8 text-sm text-slate-500 font-light">
                <div class="flex items-center gap-2"><span class="text-cyan-400">üéØ</span> Decision Rubrics</div>
                <div class="flex items-center gap-2"><span class="text-cyan-400">üì¶</span> Cluster Management</div>
                <div class="flex items-center gap-2"><span class="text-cyan-400">üë•</span> ICS Compliance</div>
            </div>
            
            <button onclick="showLeaderboard()" class="mt-8 text-cyan-400 hover:text-cyan-300 underline text-sm relative group has-tooltip">
                View Operation Records üìä
                <div class="tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-3 group-hover:visible group-hover:opacity-100">
                    <div class="tooltip-content">View saved simulation metrics</div>
                </div>
            </button>
        </div>
    </div>

    <!-- Role Selection Screen -->
    <div id="role-screen" class="hidden h-full w-full flex flex-col items-center justify-center p-6 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <h2 class="game-title text-3xl font-bold text-cyan-400 mb-2 glow-text">SELECT ICS POSITION</h2>
        <p class="text-slate-400 mb-8 font-light">Choose your function within the Incident Management Team</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-5xl w-full">
            <!-- Incident Commander -->
            <button onclick="selectRole('incident_commander')" class="ics-section-card p-6 rounded-xl hover:border-cyan-500 hover:bg-slate-800 transition-all text-left group has-tooltip relative">
                <div class="flex items-center gap-4 mb-3">
                    <span class="text-4xl">üéñÔ∏è</span>
                    <div>
                        <h3 class="font-bold text-lg text-cyan-400 group-hover:text-cyan-300">Incident Commander</h3>
                        <p class="text-sm text-slate-400">Command Staff</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-2">Set objectives, approve IAP, liaise with EOC.</p>
                <div class="text-xs text-cyan-600 font-mono">RESPONSIBILITY: HIGH</div>
            </button>
            <!-- Operations -->
            <button onclick="selectRole('operations')" class="ics-section-card p-6 rounded-xl hover:border-blue-500 hover:bg-slate-800 transition-all text-left group has-tooltip relative">
                <div class="flex items-center gap-4 mb-3">
                    <span class="text-4xl">üîß</span>
                    <div>
                        <h3 class="font-bold text-lg text-blue-400 group-hover:text-blue-300">Operations Chief</h3>
                        <p class="text-sm text-slate-400">General Staff</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-2">Tactical field ops, SAR, Medical, Fire.</p>
                <div class="text-xs text-blue-600 font-mono">RESPONSIBILITY: TACTICAL</div>
            </button>
            <!-- Planning -->
            <button onclick="selectRole('planning')" class="ics-section-card p-6 rounded-xl hover:border-indigo-500 hover:bg-slate-800 transition-all text-left group has-tooltip relative">
                <div class="flex items-center gap-4 mb-3">
                    <span class="text-4xl">üìã</span>
                    <div>
                        <h3 class="font-bold text-lg text-indigo-400 group-hover:text-indigo-300">Planning Chief</h3>
                        <p class="text-sm text-slate-400">General Staff</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-2">Situation analysis, IAP preparation, Resources.</p>
                <div class="text-xs text-indigo-600 font-mono">RESPONSIBILITY: STRATEGIC</div>
            </button>
            <!-- Logistics -->
            <button onclick="selectRole('logistics')" class="ics-section-card p-6 rounded-xl hover:border-green-500 hover:bg-slate-800 transition-all text-left group has-tooltip relative">
                <div class="flex items-center gap-4 mb-3">
                    <span class="text-4xl">üì¶</span>
                    <div>
                        <h3 class="font-bold text-lg text-green-400 group-hover:text-green-300">Logistics Chief</h3>
                        <p class="text-sm text-slate-400">General Staff</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-2">Supply, Facilities, Ground Support, Comms.</p>
                <div class="text-xs text-green-600 font-mono">RESPONSIBILITY: SUPPORT</div>
            </button>
            <!-- Finance/Admin -->
            <button onclick="selectRole('finance')" class="ics-section-card p-6 rounded-xl hover:border-emerald-500 hover:bg-slate-800 transition-all text-left group has-tooltip relative">
                <div class="flex items-center gap-4 mb-3">
                    <span class="text-4xl">üí∞</span>
                    <div>
                        <h3 class="font-bold text-lg text-emerald-400 group-hover:text-emerald-300">Finance/Admin</h3>
                        <p class="text-sm text-slate-400">General Staff</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-2">Procurement, Compensation, Cost Analysis.</p>
                <div class="text-xs text-emerald-600 font-mono">RESPONSIBILITY: FISCAL</div>
            </button>
            <!-- PIO -->
            <button onclick="selectRole('pio')" class="ics-section-card p-6 rounded-xl hover:border-purple-500 hover:bg-slate-800 transition-all text-left group has-tooltip relative">
                <div class="flex items-center gap-4 mb-3">
                    <span class="text-4xl">üì¢</span>
                    <div>
                        <h3 class="font-bold text-lg text-purple-400 group-hover:text-purple-300">Public Information</h3>
                        <p class="text-sm text-slate-400">Command Staff</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-2">Media relations, Public warnings, Rumor control.</p>
                <div class="text-xs text-purple-600 font-mono">RESPONSIBILITY: COMMS</div>
            </button>
        </div>
        <button onclick="goBack('title')" class="mt-8 text-slate-400 hover:text-cyan-400 transition-colors font-light"> ‚Üê Return to Base </button>
    </div>

    <!-- Scenario Selection Screen -->
    <div id="scenario-screen" class="hidden h-full w-full flex flex-col items-center justify-center p-6 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <h2 class="game-title text-3xl font-bold text-cyan-400 mb-2 glow-text">SELECT INCIDENT TYPE</h2>
        <p class="text-slate-400 mb-8 font-light">Choose the disaster scenario for this operation</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-5xl w-full">
            <button onclick="selectScenario('typhoon')" class="ics-section-card p-6 rounded-xl hover:border-cyan-500 hover:bg-slate-800 transition-all text-center group has-tooltip relative">
                <span class="text-5xl mb-4 block">üåÄ</span>
                <h3 class="font-bold text-lg text-cyan-400 group-hover:text-cyan-300 mb-2">Super Typhoon</h3>
                <p class="text-xs text-slate-400 mb-3">Signal No. 4 ‚Ä¢ Multi-hazard ‚Ä¢ Wind/Flood</p>
                <div class="flex justify-center gap-2">
                    <span class="px-2 py-1 bg-cyan-900/50 text-cyan-300 rounded text-xs border border-cyan-700">üí® Wind</span>
                    <span class="px-2 py-1 bg-blue-900/50 text-blue-300 rounded text-xs border border-blue-700">üåä Flood</span>
                </div>
            </button>
            <button onclick="selectScenario('earthquake')" class="ics-section-card p-6 rounded-xl hover:border-orange-500 hover:bg-slate-800 transition-all text-center group has-tooltip relative">
                <span class="text-5xl mb-4 block">üèöÔ∏è</span>
                <h3 class="font-bold text-lg text-orange-400 group-hover:text-orange-300 mb-2">Major Earthquake</h3>
                <p class="text-xs text-slate-400 mb-3">Magnitude 7.2 ‚Ä¢ Collapse ‚Ä¢ Fire</p>
                <div class="flex justify-center gap-2">
                    <span class="px-2 py-1 bg-orange-900/50 text-orange-300 rounded text-xs border border-orange-700">üèóÔ∏è Collapse</span>
                    <span class="px-2 py-1 bg-red-900/50 text-red-300 rounded text-xs border border-red-700">üî• Fire</span>
                </div>
            </button>
            <button onclick="selectScenario('flood')" class="ics-section-card p-6 rounded-xl hover:border-blue-500 hover:bg-slate-800 transition-all text-center group has-tooltip relative">
                <span class="text-5xl mb-4 block">üåä</span>
                <h3 class="font-bold text-lg text-blue-400 group-hover:text-blue-300 mb-2">Flash Flood</h3>
                <p class="text-xs text-slate-400 mb-3">Dam Release ‚Ä¢ Monsoon ‚Ä¢ Rescue</p>
                <div class="flex justify-center gap-2">
                    <span class="px-2 py-1 bg-blue-900/50 text-blue-300 rounded text-xs border border-blue-700">üö£ Rescue</span>
                    <span class="px-2 py-1 bg-indigo-900/50 text-indigo-300 rounded text-xs border border-indigo-700">üè† Evac</span>
                </div>
            </button>
        </div>
        <button onclick="goBack('role')" class="mt-8 text-slate-400 hover:text-cyan-400 transition-colors font-light"> ‚Üê Back to Role Selection </button>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen" class="hidden h-full w-full flex flex-col bg-slate-950">
        <!-- Top HUD -->
        <div class="flex-shrink-0 bg-slate-900/80 border-b border-cyan-900 p-3 backdrop-blur">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-4">
                    <div id="scenario-badge" class="flex items-center gap-2 px-3 py-1 bg-cyan-900/30 rounded border border-cyan-700 relative group has-tooltip">
                        <span id="scenario-icon">üåÄ</span>
                        <span id="scenario-name" class="font-bold text-cyan-300 text-sm tracking-wider">TYPHOON MARING</span>
                    </div>
                    <div id="alert-level" class="flex items-center gap-2 px-3 py-1 bg-red-900/30 rounded border border-red-700 alert-pulse relative group has-tooltip">
                        <span>‚ö†Ô∏è</span>
                        <span class="font-bold text-red-300 text-sm tracking-wider">SIGNAL NO. 3</span>
                    </div>
                    <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-slate-800 rounded border border-slate-700">
                        <span class="text-xs text-slate-400">ROLE:</span>
                        <span id="player-role-display" class="text-xs text-cyan-400 font-bold">IC</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 relative group has-tooltip">
                        <span class="text-slate-400 text-sm">‚è±Ô∏è</span>
                        <span id="game-timer" class="font-mono text-cyan-400 font-bold">15:00</span>
                    </div>
                    <div class="flex items-center gap-2 relative group has-tooltip">
                        <span class="text-slate-400 text-sm">üìä</span>
                        <span id="current-score" class="font-mono text-green-400 font-bold">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <!-- Left Panel - Map & Status -->
            <div class="lg:w-2/3 flex flex-col p-4 overflow-auto">
                <!-- Map Section -->
                <div class="glow-panel rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-slate-300 flex items-center gap-2">
                            <span>üó∫Ô∏è</span> Area Map - <span id="map-area-name" class="text-cyan-400">Municipality Overview</span>
                        </h3>
                        <div class="text-xs text-slate-500 font-mono">GRID: 12x8</div>
                    </div>
                    <div class="map-container">
                        <!-- Main Map Grid -->
                        <div id="game-map" class="map-grid">
                            <!-- Map cells will be generated here -->
                        </div>
                        <!-- Legend Panel -->
                        <div class="map-legend scrollbar-thin bg-slate-900/50 border border-slate-700 rounded p-3">
                            <div class="text-xs font-bold text-cyan-400 mb-2 border-b border-slate-700 pb-1">LEGEND</div>
                            <div class="space-y-2 text-xs">
                                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-900/50 border border-blue-500"></div> Urban</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-900/50 border border-green-500"></div> Land</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-cyan-900/50 border border-cyan-500"></div> Water</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-red-900/50 border border-red-500"></div> Affected</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-indigo-900/50 border border-indigo-500"></div> Flooded</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-amber-900/50 border border-amber-500"></div> Evacuated</div>
                            </div>
                            <div class="mt-4 text-xs text-slate-500 font-light">
                                üí° Hover for details. Click to act.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Dashboard -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="stat-box p-3 text-center relative group has-tooltip">
                        <div class="text-2xl mb-1">üë•</div>
                        <div id="stat-population" class="text-xl font-bold text-white">12,450</div>
                        <div class="text-xs text-slate-400">Population</div>
                    </div>
                    <div class="stat-box p-3 text-center relative group has-tooltip">
                        <div class="text-2xl mb-1">üèÉ</div>
                        <div id="stat-evacuated" class="text-xl font-bold text-green-400">0</div>
                        <div class="text-xs text-slate-400">Evacuated</div>
                    </div>
                    <div class="stat-box p-3 text-center relative group has-tooltip">
                        <div class="text-2xl mb-1">‚ö†Ô∏è</div>
                        <div id="stat-affected" class="text-xl font-bold text-amber-400">0</div>
                        <div class="text-xs text-slate-400">Affected</div>
                    </div>
                    <div class="stat-box p-3 text-center relative group has-tooltip">
                        <div class="text-2xl mb-1">üíî</div>
                        <div id="stat-casualties" class="text-xl font-bold text-red-400">0</div>
                        <div class="text-xs text-slate-400">Casualties</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Controls & Events -->
            <div class="lg:w-1/3 flex flex-col bg-slate-900/50 border-l border-slate-800 overflow-hidden">
                <!-- Resources Section -->
                <div class="p-4 border-b border-slate-800">
                    <h3 class="font-bold text-slate-300 mb-3 flex items-center gap-2 text-sm">
                        <span>üì¶</span> Resources (Cluster)
                    </h3>
                    <div id="resources-panel" class="grid grid-cols-1 gap-2">
                        <!-- Resource cards will be generated -->
                    </div>
                </div>

                <!-- Active Events / Decisions -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-slate-800 bg-slate-900/30">
                        <h3 class="font-bold text-slate-300 flex items-center gap-2 text-sm">
                            <span>üö®</span> Incident Action Plan
                        </h3>
                    </div>
                    <div id="events-panel" class="flex-1 overflow-auto p-4 scrollbar-thin">
                        <div id="current-decision" class="glow-panel rounded-lg p-4">
                            <p class="text-slate-400 text-center text-sm">Initializing Incident Command...</p>
                        </div>
                    </div>
                </div>

                <!-- Communication Log -->
                <div class="p-4 border-t border-slate-800 max-h-40 overflow-auto scrollbar-thin bg-slate-950">
                    <h3 class="font-bold text-slate-300 mb-2 text-xs flex items-center gap-2">
                        <span>üìª</span> SITREP Log
                    </h3>
                    <div id="comm-log" class="space-y-1 text-xs font-mono">
                        <div class="text-slate-600">Waiting for incoming traffic...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="hidden h-full w-full flex flex-col items-center justify-center p-6 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black overflow-auto">
        <div class="max-w-3xl w-full text-center">
            <div class="mb-6">
                <span id="result-icon" class="text-7xl float-animation">üèÜ</span>
            </div>
            <h2 class="game-title text-3xl font-bold text-cyan-400 mb-2 glow-text">OPERATION COMPLETE</h2>
            <p id="result-message" class="text-xl text-slate-300 mb-8 font-light">Incident Stabilized</p>

            <div class="glow-panel rounded-xl p-6 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-cyan-400" id="result-score">0</div>
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Final Score</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-400" id="result-saved">0</div>
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Lives Saved</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-400" id="result-efficiency">0%</div>
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Efficiency</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-400" id="result-decisions">0</div>
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Decisions</div>
                    </div>
                </div>

                <div class="border-t border-slate-700 pt-4">
                    <h4 class="font-bold text-slate-300 mb-4 text-sm uppercase tracking-wider">Performance Rubrics</h4>
                    <div id="performance-bars" class="space-y-3">
                        <!-- Performance bars will be generated -->
                    </div>
                </div>
            </div>

            <div id="result-feedback" class="glow-panel rounded-lg p-4 mb-6 text-left">
                <h4 class="font-bold text-cyan-400 mb-2 text-sm">üìã After Action Review (AAR)</h4>
                <ul id="feedback-list" class="text-sm text-slate-300 space-y-2 font-light">
                    <!-- Feedback items will be generated -->
                </ul>
            </div>

            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="restartGame()" class="btn-primary px-6 py-3 rounded text-sm">
                    üîÑ New Operation
                </button>
                <button onclick="returnToTitle()" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-bold rounded text-sm transition-all">
                    üè† Base Command
                </button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="modal-overlay absolute inset-0" onclick="hideLeaderboard()"></div>
        <div class="relative glow-panel rounded-xl p-6 max-w-lg w-full max-h-[80%] overflow-auto border border-cyan-500/30">
            <button onclick="hideLeaderboard()" class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl">√ó</button>
            <h3 class="game-title text-2xl font-bold text-cyan-400 mb-4">üìä Operation Records</h3>
            <div id="leaderboard-content" class="space-y-3">
                <p class="text-slate-400 text-center">No records yet. Complete a simulation to save your score!</p>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
</div>

<script>
// ===== CONFIGURATION & STATE =====
const defaultConfig = {
    game_title: 'PH-ICS SIMULATOR',
    lgu_name: 'Republic of the Philippines ‚Ä¢ NDRRMC Standard',
    welcome_message: 'Master emergency response through realistic disaster scenarios.',
    background_color: '#020617',
    surface_color: '#0f172a',
    text_color: '#e2e8f0',
    primary_color: '#06b6d4',
    secondary_color: '#3b82f6'
};
let config = { ...defaultConfig };
let gameRecords = [];

// Game State
let gameState = {
    playerName: '',
    role: '',
    scenario: '',
    score: 0,
    timeRemaining: 900, // 15 minutes
    timerInterval: null,
    currentPhase: 0,
    decisions: [],
    // Statistics
    population: 12450,
    evacuated: 0,
    affected: 0,
    casualties: 0,
    // Resources
    resources: {
        rescue_boats: { name: 'üö£ Rescue Boats', count: 8, max: 8, cluster: 'Search & Rescue' },
        medical_teams: { name: 'üè• Medical Teams', count: 5, max: 5, cluster: 'Health' },
        evacuation_trucks: { name: 'üöõ Evac Trucks', count: 6, max: 6, cluster: 'Logistics' },
        relief_packs: { name: 'üì¶ Relief Packs', count: 500, max: 500, cluster: 'Camp Mgmt' },
        responders: { name: 'üë∑ Responders', count: 50, max: 50, cluster: 'Operations' }
    },
    // Map Data
    mapCells: [],
    selectedCell: null,
    // Events Queue
    eventQueue: [],
    currentEvent: null,
    // Performance Metrics (Rubrics)
    metrics: {
        safety: 100,        // Life Safety (40%)
        stability: 100,     // Incident Stability (30%)
        efficiency: 100,    // Resource Efficiency (20%)
        compliance: 100     // ICS Compliance (10%)
    }
};

// ===== SCENARIOS DATA (Enhanced for ICS) =====
const scenarios = {
    typhoon: {
        name: 'Super Typhoon Maring',
        icon: 'üåÄ',
        alertLevel: 'SIGNAL NO. 4',
        alertColor: 'red',
        hazardTypes: ['flooding', 'wind_damage', 'landslide'],
        events: [
            {
                phase: 1,
                title: 'üåßÔ∏è Heavy Rainfall Warning',
                description: 'PAGASA reports 150mm rainfall. River levels rising in Barangay San Miguel. ICS Protocol: Initiate Pre-Disaster Conference.',
                options: [
                    { text: 'IC: Issue immediate evacuation order (Pre-emptive)', effect: { evacuated: 800, score: 100, time: -60, resources: { evacuation_trucks: -2 }, metrics: { safety: 5, compliance: 5 } }, feedback: 'Pre-emptive evacuation aligned with ICS safety priorities.' },
                    { text: 'Planning: Monitor situation and prepare IAP', effect: { affected: 200, score: 50, time: -30, metrics: { compliance: 10 } }, feedback: 'Proper planning but delayed response increased risk.' },
                    { text: 'PIO: Send warning through barangay officials only', effect: { affected: 400, score: 20, time: -20, metrics: { safety: -10, compliance: -5 } }, feedback: 'Limited communication reach violated cluster coordination protocols.' }
                ]
            },
            {
                phase: 2,
                title: 'üåä Flash Flood in Purok 3',
                description: 'Water levels 1.5m. 200 families trapped. ICS Protocol: Operations Section to lead SAR.',
                options: [
                    { text: 'Operations: Deploy all rescue boats immediately', effect: { evacuated: 600, score: 150, time: -90, resources: { rescue_boats: -6, responders: -20 }, metrics: { safety: 10, efficiency: -5 } }, feedback: 'Aggressive SAR saved lives but strained resources.' },
                    { text: 'Logistics: Coordinate boats with Coast Guard', effect: { evacuated: 400, casualties: 5, score: 80, time: -60, resources: { rescue_boats: -4 }, metrics: { compliance: 10, efficiency: 5 } }, feedback: 'Inter-agency coordination was efficient but slower.' },
                    { text: 'IC: Wait for water levels to stabilize', effect: { casualties: 25, score: -50, time: -30, metrics: { safety: -30, compliance: -20 } }, feedback: 'Critical failure in Life Safety priority.' }
                ]
            },
            {
                phase: 3,
                title: 'üè• Medical Emergency at Evac Center',
                description: 'Hypothermia and infections reported. ICS Protocol: Health Cluster Activation.',
                options: [
                    { text: 'Logistics: Request supplies from Provincial EOC', effect: { score: 80, time: -45, metrics: { compliance: 10, efficiency: 5 } }, feedback: 'Proper chain of command for resources.' },
                    { text: 'Operations: Redistribute existing supplies', effect: { casualties: 3, score: 60, time: -30, resources: { relief_packs: -100 }, metrics: { efficiency: 10, safety: -5 } }, feedback: 'Efficient triage but limited supplies caused issues.' },
                    { text: 'IC: Send medical teams directly', effect: { score: 100, time: -60, resources: { medical_teams: -3 }, metrics: { safety: 10 } }, feedback: 'Direct intervention improved health outcomes.' }
                ]
            },
            {
                phase: 4,
                title: 'üõ£Ô∏è Road Blocked by Landslide',
                description: 'Main highway blocked. Relief trucks stuck. ICS Protocol: Logistics Section to find alternatives.',
                options: [
                    { text: 'Logistics: Coordinate with DPWH for clearing', effect: { score: 70, time: -120, metrics: { compliance: 10 } }, feedback: 'Standard procedure followed.' },
                    { text: 'Operations: Find alternative barangay routes', effect: { score: 90, time: -60, resources: { evacuation_trucks: -1 }, metrics: { efficiency: 10, stability: 5 } }, feedback: 'Tactical adaptation resolved bottleneck.' },
                    { text: 'IC: Use boats to transport supplies via river', effect: { score: 100, time: -45, resources: { rescue_boats: -2 }, metrics: { efficiency: 15, stability: 10 } }, feedback: 'Creative logistics solution ensured continuity.' }
                ]
            },
            {
                phase: 5,
                title: 'üì¢ Misinformation Spreading',
                description: 'False dam failure reports causing panic. ICS Protocol: PIO to manage information.',
                options: [
                    { text: 'PIO: Issue official statement immediately', effect: { score: 100, time: -30, metrics: { compliance: 10, stability: 10 } }, feedback: 'Clear communication prevented panic.' },
                    { text: 'Planning: Verify with Dam Management first', effect: { affected: 100, score: 60, time: -45, metrics: { compliance: 5, stability: -5 } }, feedback: 'Verification caused delay but ensured accuracy.' },
                    { text: 'Operations: Deploy responders to manage crowd', effect: { affected: 50, score: 70, time: -60, resources: { responders: -15 }, metrics: { stability: 5 } }, feedback: 'Ground management helped but didn\'t address root cause.' }
                ]
            }
        ]
    },
    earthquake: {
        name: 'Magnitude 7.2 Earthquake',
        icon: 'üèöÔ∏è',
        alertLevel: 'INTENSITY VII',
        alertColor: 'orange',
        hazardTypes: ['collapse', 'fire', 'aftershock'],
        events: [
            {
                phase: 1,
                title: 'üèóÔ∏è Building Collapse Reported',
                description: 'Commercial district collapsed. 150 trapped. ICS Protocol: USAR Team Deployment.',
                options: [
                    { text: 'Operations: Deploy rescue teams with heavy equipment', effect: { evacuated: 100, score: 120, time: -90, resources: { responders: -30, medical_teams: -3 }, metrics: { safety: 10, stability: 5 } }, feedback: 'Immediate deployment saved trapped survivors.' },
                    { text: 'Safety: Assess structural safety before deploying', effect: { evacuated: 60, casualties: 15, score: 60, time: -60, metrics: { compliance: 10, safety: -10 } }, feedback: 'Safety assessment protected rescuers but delayed victims.' },
                    { text: 'IC: Coordinate with military for heavy equipment', effect: { evacuated: 80, casualties: 10, score: 80, time: -120, metrics: { compliance: 5 } }, feedback: 'Military assets valuable but mobilization slow.' }
                ]
            },
            {
                phase: 2,
                title: 'üî• Fire Outbreak in Residential Area',
                description: 'Gas line rupture. Fire spreading. ICS Protocol: Fire Suppression Priority.',
                options: [
                    { text: 'Operations: Evacuate and deploy fire volunteers', effect: { evacuated: 200, score: 100, time: -60, resources: { responders: -15 }, metrics: { safety: 10 } }, feedback: 'Quick evacuation prevented casualties.' },
                    { text: 'Logistics: Request BFP support', effect: { affected: 50, score: 80, time: -90, metrics: { compliance: 10 } }, feedback: 'Professional firefighting contained blaze.' },
                    { text: 'Planning: Cut power to prevent electrical fires', effect: { score: 60, time: -30, metrics: { stability: 5 } }, feedback: 'Preventive measure reduced risk.' }
                ]
            },
            {
                phase: 3,
                title: 'üè• Hospital Overwhelmed',
                description: 'District hospital over capacity. 200+ injured. ICS Protocol: Health Cluster Surge.',
                options: [
                    { text: 'Logistics: Set up field hospital at evac center', effect: { score: 100, time: -60, resources: { medical_teams: -2, relief_packs: -150 }, metrics: { stability: 10, efficiency: 5 } }, feedback: 'Field hospital managed overflow effectively.' },
                    { text: 'Operations: Coordinate patient transfers', effect: { score: 80, time: -90, resources: { evacuation_trucks: -3 }, metrics: { compliance: 5 } }, feedback: 'Patient distribution eased burden.' },
                    { text: 'IC: Request DOH emergency supplies', effect: { score: 70, time: -120, metrics: { compliance: 10 } }, feedback: 'National support replenished supplies.' }
                ]
            },
            {
                phase: 4,
                title: '‚ö†Ô∏è Strong Aftershock Warning',
                description: 'PHIVOLCS warns of Mag 6.0 aftershock. ICS Protocol: Safety Officer Assessment.',
                options: [
                    { text: 'Safety: Evacuate all damaged building areas', effect: { evacuated: 500, score: 120, time: -45, resources: { evacuation_trucks: -4, responders: -20 }, metrics: { safety: 15, compliance: 5 } }, feedback: 'Preemptive evacuation saved lives.' },
                    { text: 'PIO: Issue public warning and mark structures', effect: { affected: 100, score: 80, time: -30, metrics: { compliance: 5 } }, feedback: 'Warning helped but some ignored alerts.' },
                    { text: 'IC: Suspend rescue operations', effect: { casualties: 20, score: -30, time: -60, metrics: { safety: -20, stability: -10 } }, feedback: 'Suspension led to loss of trapped survivors.' }
                ]
            },
            {
                phase: 5,
                title: 'üè† Mass Displacement',
                description: '3,000+ homeless. Shelters needed. ICS Protocol: Camp Coordination.',
                options: [
                    { text: 'Logistics: Open schools/gyms as evac centers', effect: { evacuated: 1500, score: 100, time: -60, resources: { relief_packs: -200 }, metrics: { stability: 10, efficiency: 5 } }, feedback: 'Multiple sites accommodated families.' },
                    { text: 'IC: Request tents from DSWD', effect: { evacuated: 800, score: 80, time: -120, metrics: { compliance: 5 } }, feedback: 'Additional shelter helped but took time.' },
                    { text: 'Operations: Prioritize vulnerable for indoor shelter', effect: { evacuated: 500, affected: 300, score: 60, time: -45, resources: { relief_packs: -100 }, metrics: { safety: 5 } }, feedback: 'Triage protected vulnerable but left others exposed.' }
                ]
            }
        ]
    },
    flood: {
        name: 'Flash Flood Emergency',
        icon: 'üåä',
        alertLevel: 'RED WARNING',
        alertColor: 'blue',
        hazardTypes: ['flooding', 'landslide'],
        events: [
            {
                phase: 1,
                title: 'üíß Dam Water Release',
                description: 'Upstream dam releasing water. 2 hours warning. ICS Protocol: Early Warning System.',
                options: [
                    { text: 'IC: Immediate forced evacuation of flood plains', effect: { evacuated: 1000, score: 150, time: -90, resources: { evacuation_trucks: -4, responders: -25 }, metrics: { safety: 15, compliance: 5 } }, feedback: 'Early evacuation ensured zero casualties.' },
                    { text: 'PIO: Alert barangay captains for voluntary evac', effect: { evacuated: 600, affected: 200, score: 80, time: -60, metrics: { compliance: 5 } }, feedback: 'Voluntary evac was partially effective.' },
                    { text: 'Operations: Prepare boats for deployment after flooding', effect: { casualties: 30, affected: 400, score: -20, time: -30, resources: { rescue_boats: -4 }, metrics: { safety: -20, compliance: -10 } }, feedback: 'Reactive approach resulted in preventable casualties.' }
                ]
            },
            {
                phase: 2,
                title: 'üö£ Stranded Residents in Sitio Riverside',
                description: '80 families stranded. Water rising. ICS Protocol: SAR Priority.',
                options: [
                    { text: 'Operations: Deploy boats with medical personnel', effect: { evacuated: 300, score: 130, time: -75, resources: { rescue_boats: -6, medical_teams: -2, responders: -15 }, metrics: { safety: 10, efficiency: -5 } }, feedback: 'Comprehensive rescue saved all families.' },
                    { text: 'IC: Deploy boats, request military helicopter', effect: { evacuated: 280, score: 110, time: -90, resources: { rescue_boats: -4 }, metrics: { compliance: 10, stability: 5 } }, feedback: 'Air support accelerated critical rescue.' },
                    { text: 'Planning: Prioritize children and elderly', effect: { evacuated: 150, affected: 50, score: 80, time: -60, resources: { rescue_boats: -3 }, metrics: { safety: 5 } }, feedback: 'Prioritization protected vulnerable but delayed others.' }
                ]
            },
            {
                phase: 3,
                title: 'üè´ Evacuation Center Flooded',
                description: 'School evac center flooded. 500 evacuees need relocation. ICS Protocol: Camp Management.',
                options: [
                    { text: 'Logistics: Transfer to gymnasium on higher ground', effect: { evacuated: 500, score: 100, time: -60, resources: { evacuation_trucks: -3, responders: -10 }, metrics: { stability: 10, efficiency: 5 } }, feedback: 'Swift relocation prevented crisis.' },
                    { text: 'Operations: Move evacuees to upper floors', effect: { affected: 100, score: 60, time: -30, metrics: { safety: -5 } }, feedback: 'Temporary measure provided shelter but poor conditions.' },
                    { text: 'IC: Request provincial assistance', effect: { affected: 50, score: 80, time: -90, metrics: { compliance: 10 } }, feedback: 'Provincial support expanded capacity.' }
                ]
            },
            {
                phase: 4,
                title: 'ü¶† Waterborne Disease Outbreak Risk',
                description: 'Leptospirosis risk. Contaminated water. ICS Protocol: Health Cluster.',
                options: [
                    { text: 'Logistics: Distribute purification tablets and boots', effect: { score: 100, time: -45, resources: { relief_packs: -150 }, metrics: { safety: 10, efficiency: 5 } }, feedback: 'Preventive measures reduced disease cases.' },
                    { text: 'Operations: Set up medical checkpoints', effect: { score: 80, time: -60, resources: { medical_teams: -2 }, metrics: { safety: 5 } }, feedback: 'Health monitoring enabled early treatment.' },
                    { text: 'PIO: Issue public health advisory', effect: { affected: 50, score: 50, time: -20, metrics: { compliance: 5 } }, feedback: 'Information campaign reached limited audience.' }
                ]
            },
            {
                phase: 5,
                title: 'üåßÔ∏è Second Wave Warning',
                description: 'Another storm cell approaching. ICS Protocol: Continuity of Ops.',
                options: [
                    { text: 'IC: Expand evacuation to medium-risk areas', effect: { evacuated: 800, score: 120, time: -90, resources: { evacuation_trucks: -4, responders: -20 }, metrics: { safety: 10, stability: 10 } }, feedback: 'Proactive expansion prevented casualties.' },
                    { text: 'Logistics: Fortify current centers with supplies', effect: { score: 80, time: -60, resources: { relief_packs: -200 }, metrics: { efficiency: 5 } }, feedback: 'Preparation helped weather second wave.' },
                    { text: 'Planning: Request national disaster declaration', effect: { score: 70, time: -120, metrics: { compliance: 10 } }, feedback: 'National attention brought resources.' }
                ]
            }
        ]
    }
};

// ===== INITIALIZATION =====
async function initializeApp() {
    if (window.elementSdk) {
        window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (newConfig) => {
                config = { ...defaultConfig, ...newConfig };
                updateUIFromConfig();
            },
            mapToCapabilities: (cfg) => ({
                recolorables: [
                    { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
                    { get: () => cfg.primary_color || defaultConfig.primary_color, set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); } }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (cfg) => new Map([
                ['game_title', cfg.game_title || defaultConfig.game_title],
                ['lgu_name', cfg.lgu_name || defaultConfig.lgu_name],
                ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
            ])
        });
    }
    if (window.dataSdk) {
        const dataHandler = {
            onDataChanged: (data) => {
                gameRecords = data || [];
                updateLeaderboardDisplay();
            }
        };
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) console.error('Failed to initialize data SDK');
    }
    updateUIFromConfig();
}

function updateUIFromConfig() {
    const mainTitle = document.getElementById('main-title');
    const lguDisplay = document.getElementById('lgu-display');
    const welcomeText = document.getElementById('welcome-text');
    if (mainTitle) mainTitle.textContent = config.game_title || defaultConfig.game_title;
    if (lguDisplay) lguDisplay.textContent = config.lgu_name || defaultConfig.lgu_name;
    if (welcomeText) welcomeText.textContent = config.welcome_message || defaultConfig.welcome_message;
    document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
}

// ===== SCREEN NAVIGATION =====
function showScreen(screenId) {
    const screens = ['title-screen', 'role-screen', 'scenario-screen', 'game-screen', 'results-screen'];
    screens.forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
}

function startGame() {
    const nameInput = document.getElementById('player-name');
    gameState.playerName = nameInput.value.trim() || 'ICS Operator';
    showScreen('role-screen');
}

function selectRole(role) {
    gameState.role = role;
    document.getElementById('player-role-display').textContent = role.replace('_', ' ').toUpperCase();
    showScreen('scenario-screen');
}

function selectScenario(scenario) {
    gameState.scenario = scenario;
    initializeGame();
    showScreen('game-screen');
}

function goBack(screen) {
    showScreen(screen + '-screen');
}

// ===== GAME INITIALIZATION =====
function initializeGame() {
    const scenario = scenarios[gameState.scenario];
    gameState.score = 0;
    gameState.timeRemaining = 900;
    gameState.currentPhase = 0;
    gameState.decisions = [];
    gameState.evacuated = 0;
    gameState.affected = 0;
    gameState.casualties = 0;
    gameState.metrics = { safety: 100, stability: 100, efficiency: 100, compliance: 100 };

    Object.keys(gameState.resources).forEach(key => {
        gameState.resources[key].count = gameState.resources[key].max;
    });

    document.getElementById('scenario-icon').textContent = scenario.icon;
    document.getElementById('scenario-name').textContent = scenario.name.toUpperCase();
    document.getElementById('alert-level').innerHTML = `<span>‚ö†Ô∏è</span><span class="font-bold text-${scenario.alertColor}-300 text-sm tracking-wider">${scenario.alertLevel}</span>`;

    initializeMap();
    updateResourcesPanel();
    startTimer();
    setTimeout(() => triggerNextEvent(), 2000);
    addCommLog('üìª EOC Activated. IMT Assembly Complete.');
    addCommLog(`üåê ${scenario.name} Monitoring Initiated.`);
}

function initializeMap() {
    const mapContainer = document.getElementById('game-map');
    mapContainer.innerHTML = '';
    const mapLayout = [
        { name: 'Coastal Area', type: 'water', icon: 'üåä' }, { name: 'Port', type: 'urban', icon: '‚öì' },
        { name: 'Downtown', type: 'urban', icon: 'üè¢' }, { name: 'Market', type: 'urban', icon: 'üè™' },
        { name: 'Gov Center', type: 'urban', icon: 'üèõÔ∏è' }, { name: 'Hospital', type: 'urban', icon: 'üè•' },
        { name: 'School', type: 'urban', icon: 'üè´' }, { name: 'Resort', type: 'land', icon: 'üè®' },
        { name: 'Forest', type: 'land', icon: 'üå≤' }, { name: 'Mountain', type: 'land', icon: '‚õ∞Ô∏è' },
        { name: 'Ridge', type: 'land', icon: 'üèîÔ∏è' }, { name: 'Cliff', type: 'land', icon: 'ü™®' },
        { name: 'Fishing Vil', type: 'urban', icon: 'üé£' }, { name: 'Bridge', type: 'urban', icon: 'üåâ' },
        { name: 'Sports', type: 'urban', icon: '‚öΩ' }, { name: 'Commercial', type: 'urban', icon: 'üè≠' },
        { name: 'Residential', type: 'urban', icon: 'üèòÔ∏è' }, { name: 'Park', type: 'land', icon: 'üå≥' },
        { name: 'Farm', type: 'land', icon: 'üåæ' }, { name: 'Grassland', type: 'land', icon: 'üå±' },
        { name: 'Chapel', type: 'urban', icon: '‚õ™' }, { name: 'Comm Center', type: 'urban', icon: 'üèüÔ∏è' },
        { name: 'Industrial', type: 'urban', icon: 'üèóÔ∏è' }, { name: 'Open Water', type: 'water', icon: 'üíß' },
        { name: 'Riverside', type: 'urban', icon: 'üè†' }, { name: 'Highway', type: 'urban', icon: 'üõ£Ô∏è' },
        { name: 'Business', type: 'urban', icon: 'üíº' }, { name: 'Housing', type: 'urban', icon: 'üèòÔ∏è' },
        { name: 'City Hall', type: 'urban', icon: 'üè¶' }, { name: 'Convention', type: 'urban', icon: 'üé™' },
        { name: 'Recreation', type: 'land', icon: '‚õ∫' }, { name: 'Eco Park', type: 'land', icon: 'ü¶ã' },
        { name: 'Wildlife', type: 'land', icon: 'ü¶Å' }, { name: 'Wetlands', type: 'water', icon: 'üåø' },
        { name: 'Canal', type: 'water', icon: 'üö£' }, { name: 'Pond', type: 'water', icon: 'üê¢' },
        { name: 'Entertain', type: 'urban', icon: 'üé≠' }, { name: 'Mall', type: 'urban', icon: 'üõçÔ∏è' },
        { name: 'Resid Area', type: 'urban', icon: 'üè†' }, { name: 'Parking', type: 'urban', icon: 'üÖøÔ∏è' },
        { name: 'Office', type: 'urban', icon: 'üè¢' }, { name: 'Bank', type: 'urban', icon: 'üè¶' },
        { name: 'Library', type: 'urban', icon: 'üìö' }, { name: 'Mixed Park', type: 'land', icon: 'üé°' },
        { name: 'Garden', type: 'land', icon: 'üå∫' }, { name: 'Lake', type: 'water', icon: 'üèûÔ∏è' },
        { name: 'Dam', type: 'water', icon: 'üîß' }, { name: 'Reservoir', type: 'water', icon: 'üíß' }
    ];
    gameState.mapCells = [];
    for (let i = 0; i < mapLayout.length; i++) {
        const cellData = mapLayout[i];
        const cellData_complete = {
            id: i, name: cellData.name, type: cellData.type, icon: cellData.icon,
            status: 'normal', population: cellData.type === 'urban' ? Math.floor(Math.random() * 500) + 200 : 0,
            affected: 0, evacuated: 0
        };
        gameState.mapCells.push(cellData_complete);
        const cell = document.createElement('div');
        cell.className = `cell cell-${cellData.type} group has-tooltip`;
        cell.id = `cell-${i}`;
        cell.onclick = () => selectMapCell(i);
        cell.innerHTML = `
            <div class="text-2xl">${cellData.icon}</div>
            <div class="tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-3 group-hover:visible group-hover:opacity-100">
                <div class="tooltip-content text-center">
                    <div class="font-bold">${cellData.name}</div>
                    <div class="text-xs mt-1">${cellData.type === 'urban' ? 'üë• ' + cellData_complete.population + ' pop' : cellData.type === 'water' ? 'üíß Water body' : 'üå≥ Natural area'}</div>
                </div>
            </div>
        `;
        mapContainer.appendChild(cell);
    }
}

function selectMapCell(cellId) {
    gameState.selectedCell = cellId;
    const cell = gameState.mapCells[cellId];
    const infoPanel = document.getElementById('selected-cell-info');
    // Simplified for this version as info panel is hidden in main layout
    // Could be expanded in future iterations
}

function updateCellVisual(cellId) {
    const cell = gameState.mapCells[cellId];
    const cellElement = document.getElementById(`cell-${cellId}`);
    if(cellElement) cellElement.className = `cell cell-${cell.status !== 'normal' ? cell.status : cell.type}`;
}

function affectRandomCells() {
    const urbanCells = gameState.mapCells.filter(c => c.type === 'urban' && c.status === 'normal');
    if (urbanCells.length === 0) return;
    const numToAffect = Math.min(Math.floor(Math.random() * 3) + 1, urbanCells.length);
    for (let i = 0; i < numToAffect; i++) {
        const randomIndex = Math.floor(Math.random() * urbanCells.length);
        const cell = urbanCells[randomIndex];
        const affected = Math.floor(cell.population * (Math.random() * 0.3 + 0.2));
        cell.affected = affected;
        cell.status = Math.random() > 0.5 ? 'affected' : 'flooded';
        gameState.affected += affected;
        updateCellVisual(cell.id);
        urbanCells.splice(randomIndex, 1);
        addCommLog(`‚ö†Ô∏è ${cell.name} reporting ${affected} people in distress!`);
    }
    updateStats();
}

// ===== RESOURCES MANAGEMENT =====
function updateResourcesPanel() {
    const panel = document.getElementById('resources-panel');
    panel.innerHTML = '';
    Object.entries(gameState.resources).forEach(([key, resource]) => {
        const percentage = (resource.count / resource.max) * 100;
        let colorClass = 'bg-green-500';
        if (percentage < 30) colorClass = 'bg-red-500';
        else if (percentage < 60) colorClass = 'bg-amber-500';
        const card = document.createElement('div');
        card.className = 'bg-slate-900/50 rounded p-2 border border-slate-700';
        card.innerHTML = `
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-300">${resource.name}</span>
                <span class="text-[10px] text-slate-500">${resource.cluster}</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="flex-1 bg-slate-700 rounded-full h-2">
                    <div class="progress-bar ${colorClass} h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <span class="text-xs font-bold text-white">${resource.count}</span>
            </div>
        `;
        panel.appendChild(card);
    });
}

// ===== EVENTS & DECISIONS =====
function triggerNextEvent() {
    const scenario = scenarios[gameState.scenario];
    if (gameState.currentPhase >= scenario.events.length) {
        endGame();
        return;
    }
    const event = scenario.events[gameState.currentPhase];
    gameState.currentEvent = event;
    affectRandomCells();
    displayDecision(event);
    gameState.currentPhase++;
}

function displayDecision(event) {
    const decisionPanel = document.getElementById('current-decision');
    decisionPanel.innerHTML = `
        <div class="mb-4">
            <h4 class="font-bold text-lg text-cyan-400 mb-2">${event.title}</h4>
            <p class="text-slate-300 text-sm leading-relaxed">${event.description}</p>
        </div>
        <div class="space-y-2">
            ${event.options.map((option, index) => `
                <button onclick="makeDecision(${index})"
                class="decision-btn w-full p-3 bg-slate-800 hover:bg-slate-700 rounded text-left text-sm transition-all border border-slate-700 hover:border-cyan-500/50 text-slate-200">
                <span class="font-light">${option.text}</span>
                </button>
            `).join('')}
        </div>
        <div class="mt-3 text-center text-xs text-slate-500 font-mono">
            PHASE ${gameState.currentPhase + 1} OF ${scenarios[gameState.scenario].events.length}
        </div>
    `;
}

function makeDecision(optionIndex) {
    const event = gameState.currentEvent;
    const option = event.options[optionIndex];
    const effect = option.effect;

    gameState.decisions.push({
        phase: gameState.currentPhase,
        event: event.title,
        choice: option.text,
        feedback: option.feedback
    });

    if (effect.evacuated) gameState.evacuated += effect.evacuated;
    if (effect.affected) gameState.affected += effect.affected;
    if (effect.casualties) gameState.casualties += effect.casualties;
    if (effect.score) gameState.score += effect.score;
    if (effect.time) gameState.timeRemaining += effect.time;
    
    if (effect.resources) {
        Object.entries(effect.resources).forEach(([key, value]) => {
            if (gameState.resources[key]) {
                gameState.resources[key].count = Math.max(0, gameState.resources[key].count + value);
            }
        });
    }
    
    if (effect.metrics) {
        Object.entries(effect.metrics).forEach(([key, value]) => {
            if (gameState.metrics[key] !== undefined) {
                gameState.metrics[key] = Math.max(0, Math.min(100, gameState.metrics[key] + value));
            }
        });
    }

    updateStats();
    updateResourcesPanel();
    showNotification(`üìã ${option.feedback}`, effect.score > 50 ? 'success' : 'warning');
    addCommLog(`üìù Decision: ${option.text.substring(0, 40)}...`);

    const decisionPanel = document.getElementById('current-decision');
    decisionPanel.innerHTML = `
        <div class="text-center py-8">
            <div class="text-4xl mb-4">‚è≥</div>
            <p class="text-slate-400">Processing Response...</p>
            <p class="text-xs text-cyan-400 mt-2 font-mono">${option.feedback}</p>
        </div>
    `;
    setTimeout(() => triggerNextEvent(), 2000);
}

// ===== TIMER & STATS =====
function startTimer() {
    if (gameState.timerInterval) clearInterval(gameState.timerInterval);
    gameState.timerInterval = setInterval(() => {
        gameState.timeRemaining--;
        updateTimerDisplay();
        if (gameState.timeRemaining <= 0) endGame();
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(gameState.timeRemaining / 60);
    const seconds = gameState.timeRemaining % 60;
    document.getElementById('game-timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    if (gameState.timeRemaining <= 60) document.getElementById('game-timer').classList.add('text-red-400');
}

function updateStats() {
    document.getElementById('stat-evacuated').textContent = gameState.evacuated.toLocaleString();
    document.getElementById('stat-affected').textContent = gameState.affected.toLocaleString();
    document.getElementById('stat-casualties').textContent = gameState.casualties.toLocaleString();
    document.getElementById('current-score').textContent = gameState.score.toLocaleString();
}

// ===== COMMUNICATION LOG =====
function addCommLog(message) {
    const logContainer = document.getElementById('comm-log');
    const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const entry = document.createElement('div');
    entry.className = 'text-slate-300';
    entry.innerHTML = `<span class="text-slate-600 font-mono">[${time}]</span> ${message}`;
    logContainer.insertBefore(entry, logContainer.firstChild);
    while (logContainer.children.length > 10) logContainer.removeChild(logContainer.lastChild);
}

// ===== NOTIFICATIONS =====
function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    const colors = { success: 'bg-green-900/90 border-green-500', error: 'bg-red-900/90 border-red-500', warning: 'bg-amber-900/90 border-amber-500', info: 'bg-blue-900/90 border-blue-500' };
    const notification = document.createElement('div');
    notification.className = `${colors[type]} border text-white px-4 py-3 rounded shadow-lg max-w-sm text-sm backdrop-blur`;
    notification.textContent = message;
    container.appendChild(notification);
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// ===== GAME END & RUBRICS =====
function endGame() {
    if (gameState.timerInterval) clearInterval(gameState.timerInterval);

    // Scientific Rubric Calculation
    // Weights: Safety (40%), Stability (30%), Efficiency (20%), Compliance (10%)
    const safetyScore = gameState.metrics.safety;
    const stabilityScore = gameState.metrics.stability;
    const efficiencyScore = gameState.metrics.efficiency;
    const complianceScore = gameState.metrics.compliance;

    const weightedScore = (safetyScore * 0.4) + (stabilityScore * 0.3) + (efficiencyScore * 0.2) + (complianceScore * 0.1);
    const finalScore = Math.round(weightedScore * 10); // Scale to match existing score logic roughly

    const totalPopulation = gameState.population;
    const livesSaved = gameState.evacuated;
    const resourcesUsed = Object.values(gameState.resources).reduce((acc, r) => acc + (r.max - r.count), 0);
    const totalResources = Object.values(gameState.resources).reduce((acc, r) => acc + r.max, 0);
    const resourceEfficiency = Math.round(((totalResources - resourcesUsed) / totalResources) * 100);

    let resultIcon = 'üèÜ';
    let resultMessage = 'Outstanding Incident Management!';
    if (gameState.casualties > 50) {
        resultIcon = 'üòî';
        resultMessage = 'Critical Failures in Life Safety. Review IAP.';
    } else if (gameState.casualties > 20) {
        resultIcon = 'üìà';
        resultMessage = 'Acceptable Performance. Improvement Needed.';
    } else if (gameState.casualties > 5) {
        resultIcon = 'üëç';
        resultMessage = 'Good Response. Lives Saved.';
    }

    document.getElementById('result-icon').textContent = resultIcon;
    document.getElementById('result-message').textContent = resultMessage;
    document.getElementById('result-score').textContent = finalScore.toLocaleString();
    document.getElementById('result-saved').textContent = livesSaved.toLocaleString();
    document.getElementById('result-efficiency').textContent = resourceEfficiency + '%';
    document.getElementById('result-decisions').textContent = gameState.decisions.length;

    // Generate Performance Bars based on Rubrics
    const performanceBars = document.getElementById('performance-bars');
    performanceBars.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="w-32 text-xs text-slate-400">Life Safety (40%)</span>
            <div class="flex-1 bg-slate-700 rounded-full h-3">
                <div class="bg-green-500 h-3 rounded-full transition-all" style="width: ${safetyScore}%"></div>
            </div>
            <span class="text-xs text-white w-8 text-right">${safetyScore}</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="w-32 text-xs text-slate-400">Stability (30%)</span>
            <div class="flex-1 bg-slate-700 rounded-full h-3">
                <div class="bg-cyan-500 h-3 rounded-full transition-all" style="width: ${stabilityScore}%"></div>
            </div>
            <span class="text-xs text-white w-8 text-right">${stabilityScore}</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="w-32 text-xs text-slate-400">Efficiency (20%)</span>
            <div class="flex-1 bg-slate-700 rounded-full h-3">
                <div class="bg-blue-500 h-3 rounded-full transition-all" style="width: ${efficiencyScore}%"></div>
            </div>
            <span class="text-xs text-white w-8 text-right">${efficiencyScore}</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="w-32 text-xs text-slate-400">Compliance (10%)</span>
            <div class="flex-1 bg-slate-700 rounded-full h-3">
                <div class="bg-purple-500 h-3 rounded-full transition-all" style="width: ${complianceScore}%"></div>
            </div>
            <span class="text-xs text-white w-8 text-right">${complianceScore}</span>
        </div>
    `;

    const feedbackList = document.getElementById('feedback-list');
    feedbackList.innerHTML = gameState.decisions.slice(-3).map(d => `<li>‚Ä¢ ${d.feedback}</li>`).join('');
    if (gameState.casualties === 0) feedbackList.innerHTML += '<li class="text-green-400">‚Ä¢ Zero casualties achieved! Excellent leadership.</li>';
    if (resourceEfficiency > 80) feedbackList.innerHTML += '<li class="text-blue-400">‚Ä¢ Efficient resource utilization demonstrated.</li>';
    if (gameState.evacuated > 2000) feedbackList.innerHTML += '<li class="text-amber-400">‚Ä¢ Mass evacuation successfully coordinated.</li>';

    saveGameRecord(resourceEfficiency, finalScore);
    showScreen('results-screen');
}

async function saveGameRecord(resourceEfficiency, finalScore) {
    if (!window.dataSdk) return;
    if (gameRecords.length >= 999) return;
    const record = {
        session_id: Date.now().toString(),
        player_name: gameState.playerName,
        role: gameState.role,
        scenario: gameState.scenario,
        score: finalScore,
        casualties_prevented: gameState.evacuated,
        resources_efficiency: resourceEfficiency,
        response_time: 900 - gameState.timeRemaining,
        decisions_made: gameState.decisions.length,
        completed_at: new Date().toISOString()
    };
    const result = await window.dataSdk.create(record);
    if (!result.isOk) console.error('Failed to save game record');
}

// ===== LEADERBOARD =====
function showLeaderboard() {
    document.getElementById('leaderboard-modal').classList.remove('hidden');
    updateLeaderboardDisplay();
}
function hideLeaderboard() {
    document.getElementById('leaderboard-modal').classList.add('hidden');
}
function updateLeaderboardDisplay() {
    const content = document.getElementById('leaderboard-content');
    if (!gameRecords || gameRecords.length === 0) {
        content.innerHTML = '<p class="text-slate-400 text-center py-4">No training records yet.</p>';
        return;
    }
    const sortedRecords = [...gameRecords].sort((a, b) => b.score - a.score).slice(0, 10);
    content.innerHTML = sortedRecords.map((record, index) => {
        const scenarioIcon = record.scenario === 'typhoon' ? 'üåÄ' : record.scenario === 'earthquake' ? 'üèöÔ∏è' : 'üåä';
        const date = new Date(record.completed_at).toLocaleDateString('en-PH', { month: 'short', day: 'numeric' });
        return `
            <div class="flex items-center gap-3 p-3 bg-slate-900/50 rounded border border-slate-700">
                <div class="w-8 h-8 flex items-center justify-center font-bold ${index < 3 ? 'text-cyan-400' : 'text-slate-500'}">
                    ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : index + 1}
                </div>
                <div class="flex-1">
                    <div class="font-bold text-white">${record.player_name}</div>
                    <div class="text-xs text-slate-400">${scenarioIcon} ${record.scenario} ‚Ä¢ ${date}</div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-cyan-400">${record.score.toLocaleString()}</div>
                    <div class="text-xs text-slate-400">points</div>
                </div>
            </div>
        `;
    }).join('');
}

function restartGame() {
    showScreen('scenario-screen');
}
function returnToTitle() {
    showScreen('title-screen');
}

initializeApp();
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7422ad76a56e8a',t:'MTc2OTk3NzA4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
